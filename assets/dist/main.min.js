function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}document.addEventListener("click",function(event){const target=event.target;if(target.matches(".btn-complete-lesson")){completeLesson(target)}else if(target.matches(".btn-answer-question")){submitAnswers(target)}else if(target.matches(".btn-close-modal")){closeModal(target)}else if(target.matches(".nav-toggle")){toggleNavAvatar(target)}else if(target.closest(".edit-name")){showEditNameForm()}else if(target.closest(".edit-users .clsoe")){hideEditNameForm()}});function toggleNavAvatar(navToggle){const avatar=document.querySelector(".s-account-login__avatar img");if(avatar){avatar.style.display=navToggle.classList.contains("active")?"none":"block"}}function showEditNameForm(){const form=document.querySelector(".form-edit-name");if(form)form.style.display="block"}function hideEditNameForm(){const form=document.querySelector(".form-edit-name");if(form)form.style.display="none"}document.addEventListener("submit",function(e){if(e.target.closest(".edit-users")){e.preventDefault();var data=e.target.elements;var params="action="+data.action.value+"&fname="+data.firstname.value+"&lname="+data.lastname.value;var ajaxXhttp=new XMLHttpRequest;ajaxXhttp.open("POST","/wp-admin/admin-ajax.php",true);ajaxXhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;");ajaxXhttp.onload=function(){if(this.status>=200&&this.status<400){alert("แก้ไขชื่อ-นามสกุลเสร็จสิ้น");location.reload()}else{alert("error "+this.status)}};ajaxXhttp.send(params)}});const debouncedCompleteLesson=debounce(function(btn){const lesson_id=btn.dataset.lesson;const course_id=btn.dataset.course;const nonce=btn.dataset.nonce;if(!lesson_id||!course_id){console.error("Missing required data for completeLesson");return}const params=`action=complete_lesson_action&nonce=${nonce}&lesson_id=${lesson_id}&course_id=${course_id}`;const ajaxXhttp=new XMLHttpRequest;ajaxXhttp.open("POST","/wp-admin/admin-ajax.php",true);ajaxXhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;");ajaxXhttp.onload=function(){if(this.status>=200&&this.status<400){try{const resp=JSON.parse(this.response);if(resp.status==="completed"){alert("Lesson completed")}else if(resp.status==="next"){if(resp.next_lesson_url){window.location.href=resp.next_lesson_url}}}catch(e){console.error("Error parsing response:",e);alert("Error processing response")}}else{console.error("HTTP Error:",this.status,this.response);alert("Error: "+this.status)}};ajaxXhttp.onerror=function(){console.error("Network error occurred");alert("Network error occurred")};ajaxXhttp.send(params)},1e3);function completeLesson(btn){debouncedCompleteLesson(btn)}const debouncedSubmitAnswers=debounce(function(btn){const lesson_id=btn.dataset.lesson;const nonce=btn.dataset.nonce;const questions=document.querySelectorAll(".question");if(!lesson_id){console.error("Missing lesson_id for submitAnswers");return}if(validateAnswer(questions)){alert("กรุณาตอบคำถามให้ครบทุกข้อ");return}const answers=getQuestionAnswer(questions);const answersJson=JSON.stringify(answers);disabledAnswer(questions);const params=`action=question_answer&nonce=${nonce}&lesson_id=${lesson_id}&data=${encodeURIComponent(answersJson)}`;const ajaxXhttp=new XMLHttpRequest;ajaxXhttp.open("POST","/wp-admin/admin-ajax.php",true);ajaxXhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;");ajaxXhttp.onload=function(){if(this.status>=200&&this.status<400){try{const resp=JSON.parse(this.response);showModal()}catch(e){console.error("Error parsing response:",e);alert("Error processing response")}}else{console.error("HTTP Error:",this.status);alert("Error: "+this.status)}};ajaxXhttp.onerror=function(){console.error("Network error occurred");alert("Network error occurred")};ajaxXhttp.send(params)},1e3);function submitAnswers(btn){debouncedSubmitAnswers(btn)}function validateAnswer(questions){let invalid=false;questions.forEach(item=>{const type=item.dataset.type;let answer;if(type==="text"){const textarea=item.querySelector("textarea");if(textarea&&textarea.value.trim()!==""){answer=textarea}}else if(type==="choice"){answer=item.querySelector("input[type=radio]:checked")}if(answer){item.classList.remove("invalid")}else{item.classList.add("invalid");invalid=true}});return invalid}function disabledAnswer(questions){questions.forEach(item=>{const type=item.dataset.type;let answer;if(type==="text"){answer=item.querySelector("textarea");if(answer){answer.disabled=true}}else if(type==="choice"){const radios=item.querySelectorAll("input[type=radio]");radios.forEach(radio=>{radio.disabled=true})}})}function getQuestionAnswer(questions){const questionAnswers=[];questions.forEach(item=>{const type=item.dataset.type;const question=item.querySelector(".question-title");let answer;if(type==="text"){answer=item.querySelector("textarea")}else if(type==="choice"){answer=item.querySelector("input[type=radio]:checked")}const questionAnswer={question:question?question.innerText.trim():"",answer:answer?answer.value.trim():""};questionAnswers.push(questionAnswer)});return questionAnswers}function showModal(){const modalAlert=document.querySelector(".s-modal-alert");const modalBg=document.querySelector(".s-modal-bg");if(modalAlert){modalAlert.classList.add("show")}if(modalBg){modalBg.classList.add("show")}}function closeModal(){console.log("close modal");const modalAlert=document.querySelector(".s-modal-alert");const modalBg=document.querySelector(".s-modal-bg");if(modalAlert){modalAlert.classList.remove("show")}if(modalBg){modalBg.classList.remove("show")}}function doCapture(){const windowWidth=window.innerWidth;let scale;if(windowWidth<=480){scale=5}else if(windowWidth>480&&windowWidth<=992){scale=3}else{scale=2}const certImage=document.querySelector(".cert-iamge");if(!certImage){console.error("Certificate image element not found");return}html2canvas(certImage,{scale:scale}).then(function(canvas){const ajax=new XMLHttpRequest;ajax.open("POST","/wp-admin/admin-ajax.php",true);ajax.setRequestHeader("Content-type","application/x-www-form-urlencoded");ajax.onload=function(){if(this.status>=200&&this.status<400){downloadImage(this.responseText)}else{console.error("HTTP Error:",this.status)}};ajax.onerror=function(){console.error("Network error occurred")};ajax.send("action=get_image_capture&image="+canvas.toDataURL("image/jpeg",1))}).catch(function(error){console.error("Error capturing image:",error)})}function downloadImage(url){if(!url){console.error("Invalid image URL");return}fetch(url,{mode:"no-cors"}).then(response=>response.blob()).then(blob=>{const blobUrl=window.URL.createObjectURL(blob);const a=document.createElement("a");a.download=url.replace(/^.*[\\\/]/,"");a.href=blobUrl;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>window.URL.revokeObjectURL(blobUrl),100)}).catch(error=>{console.error("Error downloading image:",error)})}